-- Загрузка Rayfield
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Создание окна
local Window = Rayfield:CreateWindow({
    Name = "[Universal v~1.3] ",
    LoadingTitle = "Loading...",
    LoadingSubtitle = "by K",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "PlayerControl",
        FileName = "Config"
    },
    Discord = {
        Enabled = true,
        Invite = "dsc.gg/xe-no",
        RememberJoins = false
    },
    KeySystem = false,
    KeySettings = {
        Title = "Auth Required",
        Subtitle = "Enter key to continue",
        Note = "Key: 123",
        FileName = "ControlPanelKey",
        SaveKey = true,
        Key = {"123"}
    }
})

-- Tabs
local MainTab = Window:CreateTab("Main", 4483362458)
local VisualTab = Window:CreateTab("Visual", 4483362458)
local TeleportTab = Window:CreateTab("TP", 4483362458)
local KeybindTab = Window:CreateTab("Hotkeys", 4483362458)
local LoadTab = Window:CreateTab("Load Scripts", 4483362458)
local ESPTab = Window:CreateTab("ESP", 4483362458)

-- Variables
local Player = game:GetService("Players").LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local UIS = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local OriginalWalkSpeed = 16
local OriginalJumpHeight = 7.2
local OriginalFogEnd = game.Lighting.FogEnd
local OriginalBrightness = game.Lighting.Brightness
local OriginalOutdoorAmbient = game.Lighting.OutdoorAmbient
local OriginalClockTime = game.Lighting.ClockTime

local SpeedEnabled = false
local JumpEnabled = false
local FlyEnabled = false
local FlyCFrameEnabled = false
local NoclipEnabled = false
local FullbrightEnabled = false
local NoFogEnabled = false
local SpinBotEnabled = false
local SpeedCFrameEnabled = false

-- ESP Settings (based on provided script)
local ESPEnabled = false
local ESPTeamCheck = false
local ESPBoxesVisible = true
local ESPBoxColor = Color3.fromRGB(255, 80, 10)
local ESPBoxThickness = 1
local ESPBoxFilled = false
local ESPBoxTransparency = 0.7
local ESPDisableKey = Enum.KeyCode.Q

-- Teleport Settings
local TeleportUntilDies = false
local TeleportChangeAfterDeath = false

local FlySpeed = 50
local DesiredWalkSpeed = 50
local DesiredJumpHeight = 50
local SpinBotSpeed = 50
local TeleportOffsetX = 0
local TeleportOffsetY = 0
local TeleportOffsetZ = 0
local BodyVelocity
local NoclipLoop
local SpeedJumpConnection
local SpinBotConnection
local FlightLoop
local FlyCFrameLoop
local SpeedCFrameLoop

-- Functions
local function StartSpeedJumpLoop()
    if SpeedJumpConnection then
        SpeedJumpConnection:Disconnect()
    end
    
    SpeedJumpConnection = RunService.Heartbeat:Connect(function()
        if SpeedEnabled then
            Humanoid.WalkSpeed = DesiredWalkSpeed
        else
            Humanoid.WalkSpeed = OriginalWalkSpeed
        end
        
        if JumpEnabled then
            Humanoid.JumpHeight = DesiredJumpHeight
        else
            Humanoid.JumpHeight = OriginalJumpHeight
        end
    end)
end

local function StopSpeedJumpLoop()
    if SpeedJumpConnection then
        SpeedJumpConnection:Disconnect()
        SpeedJumpConnection = nil
    end
end

-- Speed CFrame Function (fixed to work like WalkSpeed)
local function StartSpeedCFrame()
    if SpeedCFrameLoop then
        SpeedCFrameLoop:Disconnect()
    end
    
    SpeedCFrameLoop = RunService.Heartbeat:Connect(function()
        if SpeedCFrameEnabled and Character and Character:FindFirstChild("HumanoidRootPart") then
            local rootPart = Character.HumanoidRootPart
            local moveDirection = Vector3.new(0, 0, 0)
            
            -- Calculate movement direction (only horizontal movement)
            if UIS:IsKeyDown(Enum.KeyCode.W) then
                moveDirection = moveDirection + Camera.CFrame.LookVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.S) then
                moveDirection = moveDirection - Camera.CFrame.LookVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.A) then
                moveDirection = moveDirection - Camera.CFrame.RightVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.D) then
                moveDirection = moveDirection + Camera.CFrame.RightVector
            end
            
            -- Set Y component to 0 for horizontal movement only
            moveDirection = Vector3.new(moveDirection.X, 0, moveDirection.Z)
            
            -- Normalize and apply speed
            if moveDirection.Magnitude > 0 then
                moveDirection = moveDirection.Unit * DesiredWalkSpeed
                -- Move only horizontally, maintain current Y position
                local currentPos = rootPart.Position
                local newPos = currentPos + moveDirection * RunService.Heartbeat:Wait()
                rootPart.CFrame = CFrame.new(newPos.X, currentPos.Y, newPos.Z) * CFrame.Angles(0, rootPart.Orientation.Y * math.pi/180, 0)
            end
        end
    end)
end

local function StopSpeedCFrame()
    if SpeedCFrameLoop then
        SpeedCFrameLoop:Disconnect()
        SpeedCFrameLoop = nil
    end
end

local function Fly()
    if FlyEnabled then
        if not BodyVelocity then
            BodyVelocity = Instance.new("BodyVelocity")
            BodyVelocity.MaxForce = Vector3.new(40000, 40000, 40000)
            BodyVelocity.P = 10000
            BodyVelocity.Velocity = Vector3.new(0, 0, 0)
            BodyVelocity.Parent = Character:FindFirstChild("HumanoidRootPart")
        end
        
        if FlightLoop then
            FlightLoop:Disconnect()
        end
        
        FlightLoop = RunService.Heartbeat:Connect(function()
            if not FlyEnabled or not Character or not Character:FindFirstChild("HumanoidRootPart") then
                if FlightLoop then
                    FlightLoop:Disconnect()
                    FlightLoop = nil
                end
                return
            end
            
            if UIS:GetFocusedTextBox() then
                if BodyVelocity then
                    BodyVelocity.Velocity = Vector3.new(0, 0, 0)
                end
                return
            end
            
            local Camera = workspace.CurrentCamera
            
            local FlyVelocity = Vector3.new(0, 0, 0)
            
            if UIS:IsKeyDown(Enum.KeyCode.W) then
                FlyVelocity = FlyVelocity + Camera.CFrame.LookVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.S) then
                FlyVelocity = FlyVelocity - Camera.CFrame.LookVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.A) then
                FlyVelocity = FlyVelocity - Camera.CFrame.RightVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.D) then
                FlyVelocity = FlyVelocity + Camera.CFrame.RightVector
            end
            if UIS:IsKeyDown(Enum.KeyCode.Space) then
                FlyVelocity = FlyVelocity + Vector3.new(0, 1, 0)
            end
            if UIS:IsKeyDown(Enum.KeyCode.LeftShift) then
                FlyVelocity = FlyVelocity - Vector3.new(0, 1, 0)
            end
            
            if FlyVelocity.Magnitude > 0 then
                FlyVelocity = FlyVelocity.Unit * FlySpeed
            end
            
            if BodyVelocity and Character:FindFirstChild("HumanoidRootPart") then
                BodyVelocity.Velocity = FlyVelocity
            end
        end)
    else
        if BodyVelocity then
            BodyVelocity:Destroy()
            BodyVelocity = nil
        end
        if FlightLoop then
            FlightLoop:Disconnect()
            FlightLoop = nil
        end
    end
end

-- Fly CFrame Function with gravity disabled
local function StartFlyCFrame()
    if FlyCFrameLoop then
        FlyCFrameLoop:Disconnect()
    end
    
    -- Disable gravity
    if Humanoid then
        Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
        Humanoid:SetStateEnabled(Enum.HumanoidStateType.Freefall, false)
    end
    
    FlyCFrameLoop = RunService.Heartbeat:Connect(function()
        if not FlyCFrameEnabled or not Character or not Character:FindFirstChild("HumanoidRootPart") then
            if FlyCFrameLoop then
                FlyCFrameLoop:Disconnect()
                FlyCFrameLoop = nil
            end
            return
        end
        
        if UIS:GetFocusedTextBox() then
            return
        end
        
        local rootPart = Character.HumanoidRootPart
        local moveDirection = Vector3.new(0, 0, 0)
        
        -- Calculate movement direction
        if UIS:IsKeyDown(Enum.KeyCode.W) then
            moveDirection = moveDirection + Camera.CFrame.LookVector
        end
        if UIS:IsKeyDown(Enum.KeyCode.S) then
            moveDirection = moveDirection - Camera.CFrame.LookVector
        end
        if UIS:IsKeyDown(Enum.KeyCode.A) then
            moveDirection = moveDirection - Camera.CFrame.RightVector
        end
        if UIS:IsKeyDown(Enum.KeyCode.D) then
            moveDirection = moveDirection + Camera.CFrame.RightVector
        end
        if UIS:IsKeyDown(Enum.KeyCode.Space) then
            moveDirection = moveDirection + Vector3.new(0, 1, 0)
        end
        if UIS:IsKeyDown(Enum.KeyCode.LeftShift) then
            moveDirection = moveDirection - Vector3.new(0, 1, 0)
        end
        
        -- Normalize and apply speed
        if moveDirection.Magnitude > 0 then
            moveDirection = moveDirection.Unit * FlySpeed
            rootPart.CFrame = rootPart.CFrame + moveDirection * RunService.Heartbeat:Wait()
        end
    end)
end

local function StopFlyCFrame()
    if FlyCFrameLoop then
        FlyCFrameLoop:Disconnect()
        FlyCFrameLoop = nil
    end
    
    -- Re-enable gravity
    if Humanoid then
        Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, true)
        Humanoid:SetStateEnabled(Enum.HumanoidStateType.Freefall, true)
    end
end

local function ToggleNoclip()
    if NoclipEnabled then
        -- Отключаем коллизию для всех частей персонажа
        for _, part in pairs(Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
        -- Отключаем коллизию для HumanoidRootPart
        if Character:FindFirstChild("HumanoidRootPart") then
            Character.HumanoidRootPart.CanCollide = false
        end
        
        -- Создаем петлю для постоянного отключения коллизии
        NoclipLoop = RunService.Stepped:Connect(function()
            if NoclipEnabled and Character then
                for _, part in pairs(Character:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
                if Character:FindFirstChild("HumanoidRootPart") then
                    Character.HumanoidRootPart.CanCollide = false
                end
            end
        end)
    else
        -- Включаем коллизию обратно
        if NoclipLoop then
            NoclipLoop:Disconnect()
            NoclipLoop = nil
        end
        
        if Character then
            for _, part in pairs(Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                end
            end
            if Character:FindFirstChild("HumanoidRootPart") then
                Character.HumanoidRootPart.CanCollide = true
            end
        end
    end
end

local function ApplyFullbright()
    if FullbrightEnabled then
        game.Lighting.Brightness = 2
        game.Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
        game.Lighting.ClockTime = 14
        game.Lighting.GlobalShadows = false
        
        for _, light in pairs(game.Lighting:GetChildren()) do
            if light:IsA("Light") then
                light.Enabled = false
            end
        end
    else
        game.Lighting.Brightness = OriginalBrightness
        game.Lighting.OutdoorAmbient = OriginalOutdoorAmbient
        game.Lighting.ClockTime = OriginalClockTime
        game.Lighting.GlobalShadows = true
        
        for _, light in pairs(game.Lighting:GetChildren()) do
            if light:IsA("Light") then
                light.Enabled = true
            end
        end
    end
end

local function ApplyNoFog()
    if NoFogEnabled then
        game.Lighting.FogEnd = 1000000
    else
        game.Lighting.FogEnd = OriginalFogEnd
    end
end

-- SpinBot на основе предоставленного скрипта
local function StartSpinBot()
    if SpinBotConnection then
        SpinBotConnection:Disconnect()
    end
    
    SpinBotConnection = RunService.Heartbeat:Connect(function()
        if SpinBotEnabled and Character and Character:FindFirstChild("HumanoidRootPart") then
            -- Получаем HumanoidRootPart
            local rootPart = Character.HumanoidRootPart
            
            -- Вращаем персонажа используя CFrame.Angles с математическим радианом
            rootPart.CFrame = rootPart.CFrame * CFrame.Angles(0, math.rad(SpinBotSpeed), 0)
        end
    end)
end

local function StopSpinBot()
    if SpinBotConnection then
        SpinBotConnection:Disconnect()
        SpinBotConnection = nil
    end
end

-- Random Target Function
local function SelectRandomTarget()
    local players = Players:GetPlayers()
    if #players <= 1 then return end
    
    local randomPlayer
    repeat
        randomPlayer = players[math.random(1, #players)]
    until randomPlayer ~= Player
    
    TeleportTab.PlayerName = randomPlayer.Name
    PlayerNameInput:Set(randomPlayer.Name)
    
    Rayfield:Notify({
        Title = "Random Target",
        Content = "Selected: " .. randomPlayer.Name,
        Duration = 3,
        Image = 4483362458
    })
end

-- ESP Functions (based on provided script)
local ESPBoxes = {}
local ESPConnections = {}
local HeadOffset = Vector3.new(0, 0.5, 0)
local LegsOffset = Vector3.new(0, 3, 0)

local function CreateESPBoxes()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Player then
            if ESPBoxes[player] then
                ESPBoxes[player]:Remove()
                ESPBoxes[player] = nil
            end
            
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChild("Humanoid") then
                local square = Drawing.new("Square")
                square.Thickness = ESPBoxThickness
                square.Transparency = ESPBoxTransparency
                square.Color = ESPBoxColor
                square.Filled = ESPBoxFilled
                square.Visible = false
                
                ESPBoxes[player] = square
            end
        end
    end
end

local function UpdateESPBoxes()
    if not ESPEnabled then
        for _, square in pairs(ESPBoxes) do
            if square then
                square.Visible = false
            end
        end
        return
    end
    
    for player, square in pairs(ESPBoxes) do
        if player and player.Parent and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChild("Humanoid") then
            local humanoid = player.Character.Humanoid
            local humanoidRootPart = player.Character.HumanoidRootPart
            
            if humanoid.Health > 0 then
                local rootPos, onScreen = Camera:WorldToViewportPoint(humanoidRootPart.Position)
                local headPos = Camera:WorldToViewportPoint(player.Character.Head.Position + HeadOffset)
                local legsPos = Camera:WorldToViewportPoint(humanoidRootPart.Position - LegsOffset)
                
                if onScreen and ESPBoxesVisible then
                    square.Size = Vector2.new(2000 / rootPos.Z, headPos.Y - legsPos.Y)
                    square.Position = Vector2.new(rootPos.X - square.Size.X / 2, rootPos.Y - square.Size.Y / 2)
                    square.Thickness = ESPBoxThickness
                    square.Transparency = ESPBoxTransparency
                    square.Color = ESPBoxColor
                    square.Filled = ESPBoxFilled
                    
                    -- Team check
                    if ESPTeamCheck then
                        if player.Team ~= Player.Team then
                            square.Visible = true
                        else
                            square.Visible = false
                        end
                    else
                        square.Visible = true
                    end
                else
                    square.Visible = false
                end
            else
                square.Visible = false
            end
        else
            if square then
                square.Visible = false
            end
        end
    end
end

local function ClearESPBoxes()
    for player, square in pairs(ESPBoxes) do
        if square then
            square:Remove()
        end
    end
    ESPBoxes = {}
    
    for _, connection in pairs(ESPConnections) do
        connection:Disconnect()
    end
    ESPConnections = {}
end

local function ToggleESP()
    if ESPEnabled then
        ClearESPBoxes()
        CreateESPBoxes()
        
        -- Update loop
        local updateConnection = RunService.RenderStepped:Connect(UpdateESPBoxes)
        table.insert(ESPConnections, updateConnection)
        
        -- Player added connection
        local playerAdded = Players.PlayerAdded:Connect(function(player)
            task.wait(1)
            if ESPEnabled and player ~= Player then
                local square = Drawing.new("Square")
                square.Thickness = ESPBoxThickness
                square.Transparency = ESPBoxTransparency
                square.Color = ESPBoxColor
                square.Filled = ESPBoxFilled
                square.Visible = false
                
                ESPBoxes[player] = square
            end
        end)
        table.insert(ESPConnections, playerAdded)
        
        -- Player removing connection
        local playerRemoving = Players.PlayerRemoving:Connect(function(player)
            if ESPBoxes[player] then
                ESPBoxes[player]:Remove()
                ESPBoxes[player] = nil
            end
        end)
        table.insert(ESPConnections, playerRemoving)
        
        -- Character added connection
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= Player then
                local characterAdded = player.CharacterAdded:Connect(function()
                    task.wait(1)
                    if ESPEnabled then
                        if ESPBoxes[player] then
                            ESPBoxes[player]:Remove()
                        end
                        
                        local square = Drawing.new("Square")
                        square.Thickness = ESPBoxThickness
                        square.Transparency = ESPBoxTransparency
                        square.Color = ESPBoxColor
                        square.Filled = ESPBoxFilled
                        square.Visible = false
                        
                        ESPBoxes[player] = square
                    end
                end)
                table.insert(ESPConnections, characterAdded)
            end
        end
    else
        ClearESPBoxes()
    end
end

-- Teleport with offset
local function TeleportToPlayerWithOffset(playerName)
    if playerName ~= "" then
        local targetPlayer = Players:FindFirstChild(playerName)
        if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local targetCFrame = targetPlayer.Character.HumanoidRootPart.CFrame
            local offsetCFrame = targetCFrame * CFrame.new(TeleportOffsetX, TeleportOffsetY, TeleportOffsetZ)
            Character:FindFirstChild("HumanoidRootPart").CFrame = offsetCFrame
            return true, targetPlayer
        end
    end
    return false, nil
end

-- UI Elements
local SpeedSection = MainTab:CreateSection("Speed and Jump")

local SpeedToggle = MainTab:CreateToggle({
    Name = "Speed Modifier (WalkSpeed)",
    CurrentValue = false,
    Flag = "SpeedToggle",
    Callback = function(value)
        SpeedEnabled = value
        if SpeedEnabled then
            SpeedCFrameEnabled = false
            SpeedCFrameToggle:Set(false)
            StopSpeedCFrame()
            Humanoid.WalkSpeed = DesiredWalkSpeed
        else
            Humanoid.WalkSpeed = OriginalWalkSpeed
        end
        
        if SpeedEnabled or JumpEnabled then
            StartSpeedJumpLoop()
        else
            StopSpeedJumpLoop()
        end
    end
})

local SpeedCFrameToggle = MainTab:CreateToggle({
    Name = "Speed Modifier (CFrame)",
    CurrentValue = false,
    Flag = "SpeedCFrameToggle",
    Callback = function(value)
        SpeedCFrameEnabled = value
        if SpeedCFrameEnabled then
            SpeedEnabled = false
            SpeedToggle:Set(false)
            StopSpeedJumpLoop()
            StartSpeedCFrame()
        else
            StopSpeedCFrame()
        end
    end
})

local SpeedInput = MainTab:CreateInput({
    Name = "Desired Speed (when enabled)",
    PlaceholderText = tostring(DesiredWalkSpeed),
    RemoveTextAfterFocusLost = false,
    Flag = "DesiredWalkSpeed",
    Callback = function(text)
        local num = tonumber(text)
        if num then
            DesiredWalkSpeed = num
            if SpeedEnabled then
                Humanoid.WalkSpeed = DesiredWalkSpeed
            end
        end
    end
})

local BaseSpeedInput = MainTab:CreateInput({
    Name = "Base Speed (when disabled)",
    PlaceholderText = tostring(OriginalWalkSpeed),
    RemoveTextAfterFocusLost = false,
    Flag = "OriginalWalkSpeed",
    Callback = function(text)
        local num = tonumber(text)
        if num then
            OriginalWalkSpeed = num
            if not SpeedEnabled then
                Humanoid.WalkSpeed = OriginalWalkSpeed
            end
        end
    end
})

local JumpToggle = MainTab:CreateToggle({
    Name = "Jump Modifier",
    CurrentValue = false,
    Flag = "JumpToggle",
    Callback = function(value)
        JumpEnabled = value
        if JumpEnabled then
            Humanoid.JumpHeight = DesiredJumpHeight
        else
            Humanoid.JumpHeight = OriginalJumpHeight
        end
        
        if SpeedEnabled or JumpEnabled then
            StartSpeedJumpLoop()
        else
            StopSpeedJumpLoop()
        end
    end
})

local JumpInput = MainTab:CreateInput({
    Name = "Desired Jump Height (when enabled)",
    PlaceholderText = tostring(DesiredJumpHeight),
    RemoveTextAfterFocusLost = false,
    Flag = "DesiredJumpHeight",
    Callback = function(text)
        local num = tonumber(text)
        if num then
            DesiredJumpHeight = num
            if JumpEnabled then
                Humanoid.JumpHeight = DesiredJumpHeight
            end
        end
    end
})

local BaseJumpInput = MainTab:CreateInput({
    Name = "Base Jump Height (when disabled)",
    PlaceholderText = tostring(OriginalJumpHeight),
    RemoveTextAfterFocusLost = false,
    Flag = "OriginalJumpHeight",
    Callback = function(text)
        local num = tonumber(text)
        if num then
            OriginalJumpHeight = num
            if not JumpEnabled then
                Humanoid.JumpHeight = OriginalJumpHeight
            end
        end
    end
})

local FlySection = MainTab:CreateSection("Flight")

local FlyToggle = MainTab:CreateToggle({
    Name = "Flight (BodyVelocity)",
    CurrentValue = false,
    Flag = "FlyToggle",
    Callback = function(value)
        FlyEnabled = value
        if FlyEnabled then
            FlyCFrameEnabled = false
            FlyCFrameToggle:Set(false)
            StopFlyCFrame()
            Fly()
        else
            if BodyVelocity then
                BodyVelocity:Destroy()
                BodyVelocity = nil
            end
            if FlightLoop then
                FlightLoop:Disconnect()
                FlightLoop = nil
            end
        end
    end
})

local FlyCFrameToggle = MainTab:CreateToggle({
    Name = "Flight (CFrame)",
    CurrentValue = false,
    Flag = "FlyCFrameToggle",
    Callback = function(value)
        FlyCFrameEnabled = value
        if FlyCFrameEnabled then
            FlyEnabled = false
            FlyToggle:Set(false)
            if BodyVelocity then
                BodyVelocity:Destroy()
                BodyVelocity = nil
            end
            StartFlyCFrame()
        else
            StopFlyCFrame()
        end
    end
})

local FlySpeedInput = MainTab:CreateInput({
    Name = "Flight Speed",
    PlaceholderText = tostring(FlySpeed),
    RemoveTextAfterFocusLost = false,
    Flag = "FlySpeed",
    Callback = function(text)
        local num = tonumber(text)
        if num then
            FlySpeed = num
        end
    end
})

local NoclipToggle = MainTab:CreateToggle({
    Name = "Noclip",
    CurrentValue = false,
    Flag = "NoclipToggle",
    Callback = function(value)
        NoclipEnabled = value
        ToggleNoclip()
    end
})

local SpinBotSection = MainTab:CreateSection("SpinBot")

local SpinBotToggle = MainTab:CreateToggle({
    Name = "SpinBot",
    CurrentValue = false,
    Flag = "SpinBotToggle",
    Callback = function(value)
        SpinBotEnabled = value
        if SpinBotEnabled then
            StartSpinBot()
        else
            StopSpinBot()
        end
    end
})

local SpinBotSpeedInput = MainTab:CreateInput({
    Name = "Spin Speed (degrees per frame)",
    PlaceholderText = tostring(SpinBotSpeed),
    RemoveTextAfterFocusLost = false,
    Flag = "SpinBotSpeed",
    Callback = function(text)
        local num = tonumber(text)
        if num then
            SpinBotSpeed = num
        end
    end
})

-- Visual Settings
local VisualSection = VisualTab:CreateSection("Visual Effects")

local FullbrightToggle = VisualTab:CreateToggle({
    Name = "Fullbright",
    CurrentValue = false,
    Flag = "FullbrightToggle",
    Callback = function(value)
        FullbrightEnabled = value
        ApplyFullbright()
    end
})

local NoFogToggle = VisualTab:CreateToggle({
    Name = "No Fog",
    CurrentValue = false,
    Flag = "NoFogToggle",
    Callback = function(value)
        NoFogEnabled = value
        ApplyNoFog()
    end
})

-- ESP Settings
local ESPMainSection = ESPTab:CreateSection("ESP Settings")

local ESPToggle = ESPTab:CreateToggle({
    Name = "ESP",
    CurrentValue = false,
    Flag = "ESPToggle",
    Callback = function(value)
        ESPEnabled = value
        ToggleESP()
    end
})

local ESPTeamCheckToggle = ESPTab:CreateToggle({
    Name = "Team Check",
    CurrentValue = false,
    Flag = "ESPTeamCheckToggle",
    Callback = function(value)
        ESPTeamCheck = value
        ToggleESP()
    end
})

local ESPBoxesVisibleToggle = ESPTab:CreateToggle({
    Name = "Boxes Visible",
    CurrentValue = true,
    Flag = "ESPBoxesVisibleToggle",
    Callback = function(value)
        ESPBoxesVisible = value
        ToggleESP()
    end
})

local ESPBoxFilledToggle = ESPTab:CreateToggle({
    Name = "Box Filled",
    CurrentValue = false,
    Flag = "ESPBoxFilledToggle",
    Callback = function(value)
        ESPBoxFilled = value
        ToggleESP()
    end
})

local ESPBoxColorPicker = ESPTab:CreateColorPicker({
    Name = "Box Color",
    Color = Color3.fromRGB(255, 80, 10),
    Flag = "ESPBoxColorPicker",
    Callback = function(color)
        ESPBoxColor = color
        ToggleESP()
    end
})

local ESPBoxThicknessSlider = ESPTab:CreateSlider({
    Name = "Box Thickness",
    Range = {1, 5},
    Increment = 1,
    Suffix = "",
    CurrentValue = 1,
    Flag = "ESPBoxThicknessSlider",
    Callback = function(value)
        ESPBoxThickness = value
        ToggleESP()
    end
})

local ESPBoxTransparencySlider = ESPTab:CreateSlider({
    Name = "Box Transparency",
    Range = {0, 1},
    Increment = 0.1,
    Suffix = "",
    CurrentValue = 0.7,
    Flag = "ESPBoxTransparencySlider",
    Callback = function(value)
        ESPBoxTransparency = value
        ToggleESP()
    end
})

-- Teleportation
local TeleportSection = TeleportTab:CreateSection("Teleport to Player")

-- Dropdown для выбора игроков
local PlayersDropdown = TeleportTab:CreateDropdown({
    Name = "Select Player",
    Options = {},
    CurrentOption = "",
    Flag = "PlayersDropdown",
    Callback = function(option)
        TeleportTab.PlayerName = option
        PlayerNameInput:Set(option)
    end
})

-- Функция для обновления списка игроков
local function UpdatePlayersList()
    local playerNames = {}
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Player then
            table.insert(playerNames, player.Name)
        end
    end
    PlayersDropdown:Refresh(playerNames, true)
end

-- Кнопка обновления списка игроков
local UpdatePlayersButton = TeleportTab:CreateButton({
    Name = "Update Players List",
    Callback = function()
        UpdatePlayersList()
        Rayfield:Notify({
            Title = "Players List Updated",
            Content = "Player list has been refreshed",
            Duration = 3,
            Image = 4483362458
        })
    end
})

-- Random Target Button
local RandomTargetButton = TeleportTab:CreateButton({
    Name = "Random Target",
    Callback = function()
        SelectRandomTarget()
    end
})

local PlayerNameInput = TeleportTab:CreateInput({
    Name = "Player Name",
    PlaceholderText = "Enter username",
    RemoveTextAfterFocusLost = false,
    Flag = "PlayerNameInput",
    Callback = function(text)
        TeleportTab.PlayerName = text
    end
})

local TeleportOffsetSection = TeleportTab:CreateSection("Teleport Offset")

local TeleportOffsetXInput = TeleportTab:CreateInput({
    Name = "Offset X",
    PlaceholderText = tostring(TeleportOffsetX),
    RemoveTextAfterFocusLost = false,
    Flag = "TeleportOffsetX",
    Callback = function(text)
        local num = tonumber(text)
        if num then
            TeleportOffsetX = num
        end
    end
})

local TeleportOffsetYInput = TeleportTab:CreateInput({
    Name = "Offset Y",
    PlaceholderText = tostring(TeleportOffsetY),
    RemoveTextAfterFocusLost = false,
    Flag = "TeleportOffsetY",
    Callback = function(text)
        local num = tonumber(text)
        if num then
            TeleportOffsetY = num
        end
    end
})

local TeleportOffsetZInput = TeleportTab:CreateInput({
    Name = "Offset Z",
    PlaceholderText = tostring(TeleportOffsetZ),
    RemoveTextAfterFocusLost = false,
    Flag = "TeleportOffsetZ",
    Callback = function(text)
        local num = tonumber(text)
        if num then
            TeleportOffsetZ = num
        end
    end
})

local TeleportSettingsSection = TeleportTab:CreateSection("Teleport Settings")

local UntilDiesToggle = TeleportTab:CreateToggle({
    Name = "Until Dies",
    CurrentValue = false,
    Flag = "UntilDiesToggle",
    Callback = function(value)
        TeleportUntilDies = value
    end
})

local ChangeAfterDeathToggle = TeleportTab:CreateToggle({
    Name = "Change After Death",
    CurrentValue = false,
    Flag = "ChangeAfterDeathToggle",
    Callback = function(value)
        TeleportChangeAfterDeath = value
    end
})

local TeleportButton = TeleportTab:CreateButton({
    Name = "Teleport",
    Callback = function()
        local playerName = TeleportTab.PlayerName or ""
        if playerName ~= "" then
            local success = TeleportToPlayerWithOffset(playerName)
            if success then
                Rayfield:Notify({
                    Title = "Success",
                    Content = "Teleported to " .. playerName .. " with offset",
                    Duration = 3,
                    Image = 4483362458
                })
            else
                Rayfield:Notify({
                    Title = "Error",
                    Content = "Player not found!",
                    Duration = 3,
                    Image = 4483362458
                })
            end
        end
    end
})

local FastTeleportToggle = TeleportTab:CreateToggle({
    Name = "Fast Teleport (Follow)",
    CurrentValue = false,
    Flag = "FastTeleportToggle",
    Callback = function(value)
        if value then
            TeleportTab.FastTeleportLoop = RunService.Heartbeat:Connect(function()
                local playerName = TeleportTab.PlayerName or ""
                if playerName ~= "" then
                    local success, targetPlayer = TeleportToPlayerWithOffset(playerName)
                    
                    if TeleportUntilDies and targetPlayer then
                        local character = targetPlayer.Character
                        local humanoid = character and character:FindFirstChild("Humanoid")
                        
                        if humanoid and humanoid.Health <= 0 then
                            if TeleportTab.FastTeleportLoop then
                                TeleportTab.FastTeleportLoop:Disconnect()
                                TeleportTab.FastTeleportLoop = nil
                                FastTeleportToggle:Set(false)
                                
                                Rayfield:Notify({
                                    Title = "Follow Stopped",
                                    Content = "Target player has died",
                                    Duration = 3,
                                    Image = 4483362458
                                })
                            end
                        end
                    elseif TeleportChangeAfterDeath and not TeleportUntilDies then
                        if not success then
                            SelectRandomTarget()
                        end
                    end
                end
            end)
        else
            if TeleportTab.FastTeleportLoop then
                TeleportTab.FastTeleportLoop:Disconnect()
                TeleportTab.FastTeleportLoop = nil
            end
        end
    end
})

-- Hotkeys
local KeybindSection = KeybindTab:CreateSection("Keybind Settings")

local function CreateKeybind(name, flag, defaultKey, callback)
    KeybindTab:CreateKeybind({
        Name = name,
        CurrentKeybind = defaultKey,
        HoldToInteract = false,
        Flag = flag,
        Callback = function(key)
            callback(key)
        end
    })
end

-- Only create keybinds for essential functions, no default keys
CreateKeybind("Speed (WalkSpeed)", "SpeedKeybind", "", function(key)
    if key ~= "" then
        SpeedEnabled = not SpeedEnabled
        SpeedToggle:Set(SpeedEnabled)
        if SpeedEnabled then
            SpeedCFrameEnabled = false
            SpeedCFrameToggle:Set(false)
            StopSpeedCFrame()
            Humanoid.WalkSpeed = DesiredWalkSpeed
        else
            Humanoid.WalkSpeed = OriginalWalkSpeed
        end
        if SpeedEnabled or JumpEnabled then
            StartSpeedJumpLoop()
        else
            StopSpeedJumpLoop()
        end
    end
end)

CreateKeybind("Speed (CFrame)", "SpeedCFrameKeybind", "", function(key)
    if key ~= "" then
        SpeedCFrameEnabled = not SpeedCFrameEnabled
        SpeedCFrameToggle:Set(SpeedCFrameEnabled)
        if SpeedCFrameEnabled then
            SpeedEnabled = false
            SpeedToggle:Set(false)
            StopSpeedJumpLoop()
            StartSpeedCFrame()
        else
            StopSpeedCFrame()
        end
    end
end)

CreateKeybind("Jump", "JumpKeybind", "", function(key)
    if key ~= "" then
        JumpEnabled = not JumpEnabled
        JumpToggle:Set(JumpEnabled)
        if JumpEnabled then
            Humanoid.JumpHeight = DesiredJumpHeight
        else
            Humanoid.JumpHeight = OriginalJumpHeight
        end
        if SpeedEnabled or JumpEnabled then
            StartSpeedJumpLoop()
        else
            StopSpeedJumpLoop()
        end
    end
end)

CreateKeybind("Flight (BodyVelocity)", "FlyKeybind", "", function(key)
    if key ~= "" then
        FlyEnabled = not FlyEnabled
        FlyToggle:Set(FlyEnabled)
        if FlyEnabled then
            FlyCFrameEnabled = false
            FlyCFrameToggle:Set(false)
            StopFlyCFrame()
            Fly()
        else
            if BodyVelocity then
                BodyVelocity:Destroy()
                BodyVelocity = nil
            end
            if FlightLoop then
                FlightLoop:Disconnect()
                FlightLoop = nil
            end
        end
    end
end)

CreateKeybind("Flight (CFrame)", "FlyCFrameKeybind", "", function(key)
    if key ~= "" then
        FlyCFrameEnabled = not FlyCFrameEnabled
        FlyCFrameToggle:Set(FlyCFrameEnabled)
        if FlyCFrameEnabled then
            FlyEnabled = false
            FlyToggle:Set(false)
            if BodyVelocity then
                BodyVelocity:Destroy()
                BodyVelocity = nil
            end
            StartFlyCFrame()
        else
            StopFlyCFrame()
        end
    end
end)

CreateKeybind("Noclip", "NoclipKeybind", "", function(key)
    if key ~= "" then
        NoclipEnabled = not NoclipEnabled
        NoclipToggle:Set(NoclipEnabled)
        ToggleNoclip()
    end
end)

CreateKeybind("Fullbright", "FullbrightKeybind", "", function(key)
    if key ~= "" then
        FullbrightEnabled = not FullbrightEnabled
        FullbrightToggle:Set(FullbrightEnabled)
        ApplyFullbright()
    end
end)

CreateKeybind("No Fog", "NoFogKeybind", "", function(key)
    if key ~= "" then
        NoFogEnabled = not NoFogEnabled
        NoFogToggle:Set(NoFogEnabled)
        ApplyNoFog()
    end
end)

CreateKeybind("Teleport", "TeleportKeybind", "", function(key)
    if key ~= "" then
        local playerName = TeleportTab.PlayerName or ""
        TeleportToPlayerWithOffset(playerName)
    end
end)

CreateKeybind("SpinBot", "SpinBotKeybind", "", function(key)
    if key ~= "" then
        SpinBotEnabled = not SpinBotEnabled
        SpinBotToggle:Set(SpinBotEnabled)
        if SpinBotEnabled then
            StartSpinBot()
        else
            StopSpinBot()
        end
    end
end)

CreateKeybind("ESP", "ESPKeybind", "", function(key)
    if key ~= "" then
        ESPEnabled = not ESPEnabled
        ESPToggle:Set(ESPEnabled)
        ToggleESP()
    end
end)

CreateKeybind("Fast Teleport (Follow)", "FastTeleportKeybind", "", function(key)
    if key ~= "" then
        FastTeleportToggle:Set(not FastTeleportToggle.CurrentValue)
        FastTeleportToggle.Callback(FastTeleportToggle.CurrentValue)
    end
end)

-- Load Scripts
local LoadSection = LoadTab:CreateSection("External Scripts")

local REMButton = LoadTab:CreateButton({
    Name = "Load Roblox Exploit Maker [REM]",
    Callback = function()
        loadstring(game:HttpGet("https://e-vil.com/anbu/rem.lua"))()
        Rayfield:Notify({
            Title = "Script Loaded",
            Content = "Roblox Exploit Maker loaded successfully!",
            Duration = 5,
            Image = 4483362458
        })
    end
})

local InfiniteYieldButton = LoadTab:CreateButton({
    Name = "Load Infinite Yield",
    Callback = function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/froumes/badinfiniteyield/refs/heads/master/source"))()
        Rayfield:Notify({
            Title = "Script Loaded",
            Content = "Infinite Yield loaded successfully!",
            Duration = 5,
            Image = 4483362458
        })
    end
})

local TouchFlingButton = LoadTab:CreateButton({
    Name = "Load Touch Fling",
    Callback = function()
        loadstring(game:HttpGet("https://pastebin.com/raw/LgZwZ7ZB",true))()
        Rayfield:Notify({
            Title = "Script Loaded",
            Content = "Touch Fling loaded successfully!",
            Duration = 5,
            Image = 4483362458
        })
    end
})

local PosManagerButton = LoadTab:CreateButton({
    Name = "Load Pos. Manager",
    Callback = function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/K-O-T/scriptblox/refs/heads/main/PositionManager"))()
        Rayfield:Notify({
            Title = "Script Loaded",
            Content = "Position Manager loaded successfully!",
            Duration = 5,
            Image = 4483362458
        })
    end
})

local CombatButton = LoadTab:CreateButton({
    Name = "Load Combat.cc",
    Callback = function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/nikoladhima/Combat/refs/heads/main/CombatAimbot"))()
        Rayfield:Notify({
            Title = "Script Loaded",
            Content = "Combat.cc loaded successfully!",
            Duration = 5,
            Image = 4483362458
        })
    end
})

-- Event Handlers
Players.LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = Character:WaitForChild("Humanoid")
    
    -- Перезапускаем петли если они были активны
    if SpeedEnabled or JumpEnabled then
        StartSpeedJumpLoop()
    end
    if SpeedCFrameEnabled then
        StartSpeedCFrame()
    end
    if FlyEnabled then
        Fly()
    end
    if FlyCFrameEnabled then
        StartFlyCFrame()
    end
    if NoclipEnabled then
        ToggleNoclip()
    end
    if SpinBotEnabled then
        StartSpinBot()
    end
end)

-- Отслеживаем добавление новых игроков
Players.PlayerAdded:Connect(function(player)
    -- Обновляем список игроков в dropdown
    UpdatePlayersList()
end)

-- Отслеживаем выход игроков
Players.PlayerRemoving:Connect(function(player)
    if player == Player then
        if FullbrightEnabled then
            game.Lighting.Brightness = OriginalBrightness
            game.Lighting.OutdoorAmbient = OriginalOutdoorAmbient
            game.Lighting.ClockTime = OriginalClockTime
        end
        if NoFogEnabled then
            game.Lighting.FogEnd = OriginalFogEnd
        end
        if NoclipLoop then
            NoclipLoop:Disconnect()
        end
        if SpeedJumpConnection then
            SpeedJumpConnection:Disconnect()
        end
        if SpeedCFrameLoop then
            SpeedCFrameLoop:Disconnect()
        end
        if SpinBotConnection then
            SpinBotConnection:Disconnect()
        end
        if FlightLoop then
            FlightLoop:Disconnect()
        end
        if FlyCFrameLoop then
            FlyCFrameLoop:Disconnect()
        end
        ClearESPBoxes()
    else
        -- Обновляем список игроков в dropdown
        UpdatePlayersList()
    end
end)

-- ESP Key handler
UIS.InputBegan:Connect(function(input)
    if input.KeyCode == ESPDisableKey and not UIS:GetFocusedTextBox() then
        ESPBoxesVisible = not ESPBoxesVisible
        ToggleESP()
        
        Rayfield:Notify({
            Title = "ESP",
            Content = "ESP boxes visibility: " .. tostring(ESPBoxesVisible),
            Duration = 3,
            Image = 4483362458
        })
    end
end)

-- Initialization
Humanoid.WalkSpeed = OriginalWalkSpeed
Humanoid.JumpHeight = OriginalJumpHeight
ApplyFullbright()
ApplyNoFog()
UpdatePlayersList() -- Инициализируем список игроков

-- Load notification
Rayfield:Notify({
    Title = "Control Panel",
    Content = "Script loaded successfully! Key: 123",
    Duration = 5,
    Image = 4483362458
})

-- Загрузка сохранённых настроек Rayfield
-- Rayfield автоматически загружает настройки для элементов с флагами при их создании
-- Мы просто проверяем, что все элементы были созданы до этого момента
wait(1)

-- Применяем начальные состояния после загрузки настроек
if SpeedEnabled then
    Humanoid.WalkSpeed = DesiredWalkSpeed
end

if JumpEnabled then
    Humanoid.JumpHeight = DesiredJumpHeight
end

if ESPEnabled then
    ToggleESP()
end

Rayfield:LoadConfiguration()
